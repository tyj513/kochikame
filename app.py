import re
import json
from linebot.models import QuickReply, QuickReplyButton, MessageAction
from linebot.models import FlexSendMessage
from linebot.models import BubbleContainer, BoxComponent, TextComponent, ImageComponent, ButtonComponent, IconComponent, SeparatorComponent

import random
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, ImageSendMessage
import os
from dotenv import load_dotenv

# è¼‰å…¥ .env æª”æ¡ˆ
load_dotenv()

# è®€å–ç’°å¢ƒè®Šæ•¸
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
episode_titles = {
    "1": "å…©æ´¥è­¦å“¡å‡ºç¾!?",
    "2": "å¾žå¤©è€Œé™çš„æ–°é€²è­¦å“¡",
    "3": "ç©ºä¸­æ”¤è²©ï¼ç”Ÿæ„èˆˆéš†",
    "4": "ä¸­æ¨‚é€å½©çš„æš´ç™¼æˆ¶",
    "5": "åœ¨åˆ¨å†°ä¸Šç›¡æƒ…æ»‘é›ª",
    "6": "éº—å­ç™¼é£†ç˜‹ç‹‚è¿½è¿½è¿½",
    "7": "é†’ä¾†å§ï¼å†¬çœ è­¦å¯Ÿ",
    "8": "æ‰“é–‹å§ï¼å‹é¬¨æ©‹ï¼",
    "9": "åŠ æ²¹å•Šï¼å ´å¤–ç›¸æ’²æ¯”è³½",
    "10": "è„«ç·šâ€§æš´èµ°â€§å¤§çˆ†èµ°ï¼æ‹¼å‘½çš„äº¤é€šå®‰å…¨è¬›ç¿’ï¼",
    "11": "æ‹œè¨ªä¸­å·çš„å®¶",
    "12": "æ±Ÿæˆ¶äººçš„æ¿€çƒˆæˆ°å½¹",
    "13": "é˜¿å…©å’Œéº—å­å½¢å½±ä¸é›¢!?",
    "14": "è¿·è·¯å°è±¡çš„å‡æ—¥",
    "15": "æœ¬ç”°ç‚ºæ„›å¥”èµ°",
    "16": "æ‰€é•·å®¶çš„ç¥žç§˜å¯¶ç‰©",
    "17": "èŸ‘èž‚å¤§ç«¶è³½",
    "18": "é‡ç¾äº¬éƒ½ä¹‹æ—…",
    "19": "è•Žéº¥éºµå±‹çš„é‡æŒ¯è¨ˆç•«ï¼",
    "20": "å…©æ´¥å¼çš„è€ƒè©¦å¿…å‹æ³•",
    "21": "çŽé‡‘çˆ­å¥ªæˆ°",
    "22": "å…©æ´¥æœ€å—æ­¡è¿Žå®£è¨€",
    "23": "æ–°æ˜¥çš„æˆ°é¬¥ç´™ç‰Œ",
    "24": "æ—¥æœ¬æœ€æ²’è²¬ä»»æ„Ÿçš„çˆ¶å­",
    "25": "åœ¨å®¶é—œç¦é–‰æ‰ä¸å¯æ€•ï¼",
    "26": "è³ºæ”¶è¦–çŽ‡ï¼",
    "27": "è¶…ç´šæœ‰éŒ¢äººï¼ç™½é³¥éº—æ¬¡",
    "28": "é˜¿å…©å¤§é€ƒäº¡",
    "29": "ç”·äººä¹‹é–“çš„æºé€šæ©‹æ¨‘ï¼æªœæœ¨æ¾¡å ‚",
    "30": "ä¸‰æœˆä¸‰æ—¥å¨ƒå¨ƒç¯€",
    "31": "å¿è€…V.S.å°åœ°å®‰å…©æ´¥",
    "32": "é˜¿å…©ç¾åœ¨ä¿®è¡Œä¸­",
    "33": "å•Šï½žå¥½æƒ³æœ‰è‡ªå·±çš„æˆ¿å­",
    "34": "é«˜ç§‘æŠ€å°å­¸ç”ŸV.S.å…©æ´¥",
    "35": "ç†±æ·šç›ˆçœ¶çš„æ‰€é•·",
    "36": "å¥ªå›žç§˜å¯†ç…§ç‰‡",
    "37": "ä¸è¦å‘½çš„åƒåˆ°é£½",
    "38": "ç™½é³¥éº—æ¬¡å†åº¦ç™»å ´",
    "39": "ç†±æˆ€ä¸­çš„å…©æ´¥å’Œéº»é‡Œæ„›",
    "40": "çˆ†ç¬‘çš„ç¿»å¢®ç¾…æ‹³æ³•",
    "41": "åˆæˆ€æƒ…äººæ˜¯å…©æ´¥ï¼ï¼Ÿ",
    "42": "é±·é­šçš„æ¼”è—ç”Ÿæ¶¯å¿ƒé…¸å²",
    "43": "å‘¼é¢¨å–šé›¨çš„æ£’çƒè³½",
    "44": "å…©æ´¥å‹˜å‰çš„é–ƒé›»çµå©š",
    "45": "é˜¿å…©çš„å¯¦ç¿’ç”Ÿè¨“ç·´è¨˜",
    "46": "é˜¿å…©çš„äººå½¢å¨ƒå¨ƒç†±è³£ä¸­",
    "47": "ç·Šå¼µåˆºæ¿€ï¼æ€¥æµä¸­çš„éŠèˆ¹",
    "48": "é˜¿å…©ç”·æ‰®å¥³è£å¤§ä½œæˆ°",
    "49": "åˆ°åŠ æ‹¿å¤§ç·´ç¿»å¢®ç¾…æ‹³",
    "50": "ç¾Žå‘³çš„å¾©ä»‡é£Ÿè­œ",
    "51": "åˆ©ç”¨å¹½éˆè³ºå¤§éŒ¢",
    "52": "æ¿€å‹•æ´¾çš„è¶…ç´šè¾£åª½",
    "53": "æ·ºè‰åˆæˆ€ç‰©èªž",
    "54": "è¶…æ¿€çƒˆçš„éŠæˆ²çŽ©å®¶ï¼å·¦è¿‘å¯º",
    "55": "é€ æˆå¤§æ··äº‚çš„ä¸‹æµç…§ç‰‡",
    "56": "ç¥žå‹‡çš„çˆºçˆº",
    "57": "æ­¡è¿Žå¥³æ€§ä¾†ä½å¾®ç¬‘å®¿èˆï¼",
    "58": "æ‰€é•·çš„ç§ç”Ÿå­ç–‘æ¡ˆ",
    "59": "å‡ºå‹•æ¾èŒ¸å®ˆè¡›éšŠ",
    "60": "ç¿»å¢®ç¾…æ‹³ï¼Œåƒéˆžä¸€é«®ï¼",
    "61": "å†è¦‹äº†ï¼Œå¤§åŽŸæ‰€é•·ï¼ï¼Ÿ",
    "62": "å‘å‰è¡å§ï¼å¤±æˆ€çš„æ©Ÿè»Šé¨Žå£«",
    "63": "è­¦ç½²å…§çš„å ±ç´™å¤§æˆ°",
    "64": "çŽé‡‘çˆ­å¥ªæˆ°Partï¼’",
    "65": "å‡ºå·®ç—‡å€™ç¾¤",
    "66": "è¿½è¹¤ï¼åçŠ¬å…©æ´¥",
    "67": "é©šäººçš„ç„¡åŽ˜é ­æ–°å¹´èšæœƒ",
    "68": "å°æ±ºï¼é‡£é¦¬å­",
    "69": "è€çˆºçˆºå’Œç‚¸å½ˆç¶åŒª",
    "70": "æœ¬ç”°çš„æœ€å¾Œä¸€å€‹æˆ€æƒ…",
    "71": "æœƒä»¤äººä¸Šç™®çš„ç¾Žå°‘å¥³äººå½¢",
    "72": "ç‡ƒç‡’å§ï¼å°éœ²ç‡Ÿçš„ç†±æƒ…",
    "73": "çƒé¾æ•™æŽˆç™»å ´",
    "74": "çµ•å°æ”¾å¿ƒï¼å…©æ´¥è§€å…‰",
    "75": "å¦–æ€ªç…™å›ªæ¶ˆå¤±çš„æ—¥å­",
    "76": "ææ€–çš„ç½®ç‰©æ«ƒ",
    "77": "æ¬²æœ›ä¹‹çœŸäººæŠ“å¨ƒå¨ƒæ©Ÿ",
    "78": "æ¿€çƒˆçš„ç¤¾é•·â”€ä¸­å·çš„çˆ¶è¦ª",
    "79": "è¶…çƒé¾çš„æ–°ç™¼æ˜Ž",
    "80": "ç‚ºç¨®èŠ±è€Œå¥®æˆ°çš„é˜¿å…©",
    "81": "æ³¢çˆ¾æ³¢çš„åŒå±…æ™‚ä»£",
    "82": "é£›å§ï¼è­¦è»Šä¸Šå¸",
    "83": "åœä¸ä¸‹ä¾†çš„æ”¤è²©åˆ—è»Šï¼",
    "84": "è¯éº—çš„è®Šèº«ï¼æœˆå…‰åˆ‘è­¦",
    "85": "æœªçˆ†å½ˆé€è²¨åˆ°åºœ",
    "86": "å…©æ´¥æ­»äº†ï¼ä»€éº¼ï¼Ÿ",
    "87": "è²¼ç·Šï¼å±éšªçš„å…©äºº",
    "88": "æ“Šæ²‰ï¼å¿è€…è€çˆºçˆº",
    "89": "ææ€–çš„äº¤é€šå®‰å…¨æŒ‡å°Žæ•™å®˜",
    "90": "é´¿å­å’•å’•åˆ‘è­¦èª•ç”Ÿï¼",
    "91": "ææ€–ï¼æˆ‘çš„é•·é«®æ€ªæœ‹å‹",
    "92": "å¤§å®¶ä¾†æ‰“æ£’çƒ",
    "93": "é€™ä½å°±æ˜¯æˆ‘å–œæ­¡çš„äºº",
    "94": "å¾žå¤–å¤ªç©ºæŽ‰ä¸‹ä¾†çš„ç¦®ç‰©",
    "95": "ä»¤äººç¨±ç¾¨çš„å…©äººåˆç…§",
    "96": "è¢«è©›å’’çš„æ¢…å­å£º",
    "97": "ä¸­å·æ˜¯ä¸‹ç”ºäººå—Žï¼Ÿ",
    "98": "æ²’æœ‰ç‰™é½’å°±ä¸èƒ½èªªçš„æ•…äº‹/é˜¿å…©è¦åŽ»æœˆçƒäº†",
    "99": "æˆ‘æ‰æ˜¯ä¸»è§’ï¼æ˜Ÿé€ƒç”°",
    "100": "æ„›çš„è²¼èº«ä¿é‘£",
    "101": "çª®é€”æœ«è·¯çš„æœ€é‚Šé™²ç½²",
    "102": "æ·ºè‰çš„é›»å½±é™¢æ¨‚åœ’",
    "103": "çƒé¾œçš„å ±æ©",
    "104": "è®Šèº«ï¼æ‰€é•·çš„æ–°è»Š",
    "105": "çŽé‡‘çˆ­å¥ªæˆ°3",
    "106": "ç¿»å¢®ç¾…æ›¿èº«æ‹³",
    "107": "å…©æ´¥è®Šå°äº†ï¼",
    "108": "æ·ºè‰ç‰©èªž",
    "109": "å“¥å“¥çš„èº«ä»½",
    "110": "è¦ªæˆšçš„èº«ä»½",
    "111": "ç’°éŠä¸–ç•Œ48å°æ™‚",
    "112": "éº»é‡Œæ„›ï¼Œæ„›çš„éµæ‹³ï¼",
    "113": "é€†è¥²ï¼å ±æ‡‰è€é ­",
    "114": "è¡å•Šï¼éº—å­å¤§è¿½è¹¤",
    "115": "äººä¸–é–“åš´ç¦ç«ç‡­",
    "116": "ç§˜è—¥å…©æ´¥GPX",
    "117": "æœ¬ç”°ä¸€å®¶--1",
    "118": "åœ¨ä¹Žï¼Œä¹Ÿæ˜¯ç¨®æˆ€æ„›",
    "119": "å¤šé‡‡å¤šå§¿çš„ç”Ÿæ´»æ–¹å¼/ç¦å¾žè‡‰å‡º",
    "120": "èœé³¥åˆ‘è­¦--å…©æ´¥",
    "121": "ä¸è¦å«æˆ‘çˆ¸çˆ¸ï¼",
    "122": "å·¦è¿‘å¯º å…¨æ–°çš„å‡ºç™¼",
    "123": "é™é çš„æ”¾å­¸å¾Œ......",
    "124": "é›¢å¥§é‹é–‹å¹•é‚„æ—©å¾—å¾ˆï¼Ÿ",
    "125": "æˆ€æ„›çš„æ²–é¸å³¶",
    "126": "é£›å§ï¼èˆªç©ºè­¦å¯ŸéšŠ",
    "127": "æ„Ÿå‹•ï¼å¯ºäº•çš„åˆé«”é©—",
    "128": "å…©æ´¥æˆç‚ºæ¼«ç•«å®¶ï¼",
    "129": "æ¿€çƒˆçš„è¸¢ç½å­æˆ°çˆ­",
    "130": "è«¾æ–¯ç‰¹æ‹‰å…©æ´¥çš„å¤§é è¨€",
    "131": "å®¶åº­éŒ„å½±å¸¶ä¹‹çŽ‹",
    "132": "é¾œæœ‰çš„å¯§éœä¹‹å¤œ",
    "133": "æ±ºæˆ°ï¼å¤§ç ´é«˜çˆ¾å¤«çƒå ´",
    "134": "æŸ¥ç†å°æž—çš„ç§˜å¯†",
    "135": "è’å”æ·±æµ·SOS",
    "136": "å·¥ä½œå§!!æ¾å‰",
    "137": "åœ¨å¤œç©ºä¸­ç¶»æ”¾çš„ç¦®ç‰©",
    "138": "å…©æ´¥é«”åŠ›æœ‰é™å…¬å¸",
    "139": "æ„›ç¬‘çš„æƒ æ¯”å£½",
    "140": "æ’²å…‹ç‰Œå¤§æˆ°",
    "141": "æ©Ÿæ¢°è­¦å¯Ÿå‡ºå‹•",
    "142": "å²ç‰¹æ‹‰ç¬¬å¤§è¿½ç¸±",
    "143": "å®‡å®™äººçš„é€†è¥²",
    "144": "çŽé‡‘çˆ­å¥ªæˆ°4",
    "145": "æ™‚é–“å•Šï¼åœæ­¢å§ï¼/æ¥µæ¨‚å•Šï¼ä½ åœ¨é‚£å•Šï¼",
    "146": "é™é çš„å¯ºäº•å®¶",
    "147": "é éˆ£è³ªæ’éŽåŽ»ï¼",
    "148": "è‚‰é«”æ´¾é­”è¡“å¸«",
    "149": "å°ç”ºæˆç‚ºæ˜Žæ˜Ÿ",
    "150": "å¯¦éŒ„éŒ„å½±å¸¶æ”å½±å¸«",
    "151": "ç±³å’Œé£¯åœ˜çš„æ—…è¡Œ",
    "152": "åœ°ç„èˆ¬çš„å¯„å®¿ç”Ÿæ´»",
    "153": "å¤§å“¥å¤§ææ…Œ",
    "154": "æº«æ³‰æ—…è¡Œ",
    "155": "ä¸å¿æ± çš„å›žæ†¶",
    "156": "æ±ºæˆ°å¤§è‡ªç„¶é«˜çˆ¾å¤«",
    "157": "ä¸­å·çš„å¹³æ°‘ç”Ÿæ´»è‹¦é¬¥è¨˜",
    "158": "é‡æ–°å‰µé€ ä¸€æ¬¡äººç”Ÿ/è²éŸ³æ¨¡ä»¿å®¶",
    "159": "äººç”Ÿä¸­æœ€å€’æ¥£çš„ä¸€å¤©",
    "160": "é£›è¶Šæµ·æ´‹çš„æ„›æƒ…",
    "161": "åˆ©ç”¨å‹•ç•«å¡é€šè³ºâ€§å¤§â€§éŒ¢ï¼",
    "162": "å‹æƒ…çš„ç¿…è†€",
    "163": "é«˜ç§‘æŠ€ç¤¾é•·ä¸€å®¶äºº",
    "164": "å¿è¾±è² é‡çš„å·¥ä½œ",
    "165": "å‡ºç¾äº†ï¼å°‘å¥³æ¼«ç•«åˆ‘äº‹ï¼",
    "166": "ç½é›£çš„ç™¼ç”Ÿç¸½æ˜¯åœ¨å¤§æ„æ™‚",
    "167": "çµ‚æ¥µæˆ°è­¦å…©æ´¥",
    "168": "å…©æ´¥çš„èº«é«”æª¢æŸ¥",
    "169": "å…‰è¼çš„çƒå ´",
    "170": "ä¸‹ç”ºäº¤ç•ªæ—¥è¨˜(å°åœ°æ–¹æ´¾å‡ºæ‰€çš„æ—¥è¨˜)",
    "171": "åŠé“ä¸€ç›´ç·šï¼",
    "172": "å‹˜å‰éƒŽçš„å¤å¤©",
    "173": "æ¿€çƒˆè¡çªæ…ˆå–„ç¾©è³£æœƒ",
    "174": "å†¬çœ è­¦å®˜è¦å›žä¾†äº†ï¼",
    "175": "ç§˜å¢ƒï¼åº¦äº•ä»²ç¸£ï¼",
    "176": "é¦¬æˆ²åœ˜äº¤éŸ¿æ›²",
    "177": "é€å ±å°‘å¹´å‹˜å‰çš„æ•…äº‹",
    "178": "å¤§è¡çªï¼å…©æ´¥V.S.çƒé´‰ï¼",
    "179": "åœ­ä¸€ã€éº—å­çš„å¤«å¦»æ¼«æ‰",
    "180": "é˜¿å…©é–‹è¨ˆç¨‹è»Š",
    "181": "å¿«è·‘ï¼ç©©è´é‡‘å¤ªéƒŽï¼",
    "182": "å…©æ´¥æˆç‚ºè—è¡“å®¶",
    "183": "æœ¬ç”°ä¸€å®¶2--ä¼Šæ­¥çš„å¯¶ç‰©",
    "184": "èª¤æœƒä¸€å ´",
    "185": "å…©æ´¥åŠ å…¥é¸èˆ‰",
    "186": "çŽé‡‘çˆ­å¥ªæˆ°5",
    "187": "èº«é«”äº¤æ›è¨˜",
    "188": "å¯ºäº•ï¼Œå›ºåŸ·çš„è¿½æŸ¥",
    "189": "é€™è£¡æ˜¯éŠ€åº§ç½²æ­Œèˆžä¼Žç”ºæ´¾å‡ºæ‰€ï¼",
    "190": "é†’ä¾†å§ï¼è€å¯¦äººå…©æ´¥",
    "191": "å¤§æ±Ÿæˆ¶æœæŸ¥ç¶²",
    "192": "æ•™ä½ å¦‚ä½•é£¼é¤Šå¯µç‰©å§",
    "193": "å›žä¾†äº†ï¼äº¤é€šå®‰å…¨ä¹‹é¬¼",
    "194": "ç„¡è»Œé›»åŠ›å…¬è»Šçš„æ•…äº‹",
    "195": "æ‚²æ…˜çš„ç”Ÿæ—¥",
    "196": "è–æ©‹çš„ç™½ç·šé£„æµ",
    "197": "çµ¦è¦ªæ„›çš„å¤§å“¥",
    "198": "äººæƒ…ç¾©ç†çš„æ–è—æ›²",
    "199": "å¿«å¹«æˆ‘æŠŠå¡—é´‰æ“¦æŽ‰å•Š~~~~~ï¼",
    "200": "å…©æ´¥åŸŽæ”¹é€ è¨ˆåŠƒ",
    "201": "ç«Šå–æ”¶è¦–çŽ‡çš„ç”·äºº",
    "202": "å…©æ´¥çš„ç¦é…’ä»¤",
    "203": "è¶…ç´šç·¨è¼¯",
    "204": "å…©æ´¥æˆç‚ºæœ‰éŒ¢äºº",
    "205": "åº¶æ°‘å€è­¦å¯Ÿ",
    "206": "è¶…ç´šå¹¼ç¨šåœ’å…’ç«¥--æª¸æª¬ï¼",
    "207": "å¿è€…å­¸æ ¡é–‹å­¸äº†ï¼",
    "208": "çˆ¸çˆ¸æ˜¯å­©å­çŽ‹ï¼",
    "209": "æ†¤æ€’çš„èƒ¸åƒ~~",
    "210": "éº—å­ï¼Œå¤å¤©çš„å›žæ†¶......",
    "211": "åœ¨åäºŒæ¨“è¦‹",
    "212": "ä¸€å„„å…ƒçˆ­å¥ªæˆ°",
    "213": "å»Ÿæœƒå¤ªé¼“",
    "214": "å†è¦‹äº†ï¼Œå…©æ´¥......",
    "215": "æ±ºå®šï¼æŽ’è¡Œæ¦œçŽ‹ï¼",
    "216": "é­”æ³•æ°´å£º",
    "217": "å¤©æ‰å°å­¸ç”Ÿçš„åˆæˆ€(å°æª¸æª¬ä¸€è¦‹é¾æƒ…)",
    "218": "è¶…ç´šè€ç£å¯Ÿæœ€å®Œç¾Žçš„ä¸€å¤©",
    "219": "å…©æ´¥çš„è‡‰",
    "220": "å°å¿ƒå¼·è¿«æŽ¨éŠ·ï¼",
    "221": "æˆ‘æ˜¯å¥³æ¼”å“¡--é¾œæœ‰å…©å­ï¼",
    "222": "å²ä¸Šæœ€æ…˜ä¹‹é€ƒè„«äº‹ä»¶",
    "223": "çŽé‡‘çˆ­å¥ªæˆ°6",
    "224": "éœ²é¤¡äº†ï¼å°å·æ ªå¼æœƒç¤¾",
    "225": "é£›å‘å¤©ç©ºå§ï¼è–èª•ç¯€",
    "226": "æª¸æª¬çš„çˆ¶è¦ªåƒè§€æ—¥",
    "227": "é£›å§ï¼é­”æ³•é£›æ¯¯",
    "228": "æ•´äººå‡æƒ…å ±çš„å…©æ´¥é‹",
    "229": "è­¦å¯Ÿä¾¿åˆ©åº—",
    "230": "ä»Šæ™šç¾å ´ç›´æ’­ï¼ï¼Ÿ",
    "231": "é¾è¦ï¼èžƒèŸ¹ï¼é­·é­šï¼å·¨å¤§ç”ŸåŒ–ç”Ÿç‰©ä¾†è¥²ï¼/æˆ¿å®¢çš„é¡è‰²",
    "232": "ç†Šå¯¶å¯¶å¤§ä½œæˆ°",
    "233": "æ…˜æ…˜æ…˜ï¼æ‚²åŠ‡é‡æ¼”çš„ç”Ÿæ—¥ï¼",
    "234": "å†’éšªå®¶å‹˜å‰",
    "235": "æ‰“å—æ­¢ä¸ä½~~~~ï¼",
    "236": "å–„è‰¯çš„å°å·",
    "237": "å…©æ´¥å’Œæª¸æª¬çš„äº¬éƒ½æ—…è¡Œ",
    "238": "æ„›æƒ…å¤§æ²‰æ²’ï¼ï¼",
    "239": "è¡—é ­è¶³çƒè³½2002",
    "240": "é‡è¦‹é‘°åŒ™ç‹‚",
    "241": "ä¸­å·å°‹çˆ¶ä¸‰åƒé‡Œ",
    "242": "å…©æ´¥ï¼Œæœ€é•·çš„ä¸€å¤©/æ˜Ÿé€ƒç”°è­¦å®˜å†åº¦ç™»å ´ï¼",
    "243": "æ¥µå¯†ä»»å‹™ï¼å»ºé€ äº”é‡å¡”",
    "244": "æœ¬ç”°å¤§éœ‡æ’¼ï¼ä¼Šæ­¥è¦çµå©šäº†ï¼Ÿï¼",
    "245": "é«˜æœ‹æ»¿åº§ï¼è‘›é£¾æ‘”è§’å¤§è³½ï¼",
    "246": "å¯ºäº•è·‘å§ï¼ç‚ºäº†å…’å­æ‹¿åˆ°ç´€å¿µç« ï¼",
    "247": "é–‹ç™¼è­¦ç”¨æ©Ÿå™¨äºº004è™Ÿå¤±æ•—å¤ªéƒŽç™»å ´ï¼",
    "248": "éš±å½¢åˆ‘è­¦å‡ºç¾äº†ï¼",
    "249": "æª¸æª¬ç•¶å§Šå§Šäº†",
    "250": "ä¸€é€±å…§åƒä¸‹300å€‹è¥¿ç“œçš„ç”·äºº",
    "251": "å°å…©æ´¥æ˜¯å°å¦–ç²¾å—Žï¼ï¼Ÿ",
    "252": "æ³³è£ç…§å¤§é€²æ“Š",
    "253": "æ´¾å‡ºæ‰€æœ‰å¥½æº«æ³‰ï¼",
    "254": "ç«å†’ä¸‰ä¸ˆçš„æ©Ÿå™¨è­¦å¯Ÿ",
    "255": "å…©æ´¥çš„(ä¸‹ç”º)å¹³æ°‘ä¹‹æ—…",
    "256": "æ¡ƒå¤ªç°å§‘å¨˜ï¼Ÿ/å‚³çœŸæˆ‘çš„ä¸€åˆ‡ï¼",
    "257": "åˆ©ç”¨ç™‚å‚·ç³»è³ºå¤§éŒ¢ï¼",
    "258": "é›£çºçš„å¾¡æ‰€æ²³åŽŸå¤§çˆº",
    "259": "é¨™äººçš„å…©æ´¥å’Œè¢«é¨™çš„å…©æ´¥",
    "260": "é»ƒé‡‘å‚³èªªå¤§æ±ºæˆ°ï¼ç¯€ç´„èƒ½æºå¤§ä½œæˆ°",
    "261": "å…©æ´¥çš„ç‹—å…’ç”Ÿæ´»",
    "262": "ä¸‹ç”ºæ¾¡å ‚çš„å£ç•«",
    "263": "å…©æ´¥æ’¿åˆ°å¯¶ï¼ç§˜å¯†æ•´äººå¯¦æ³",
    "264": "çŽé‡‘çˆ­å¥ªæˆ°7",
    "265": "å¤©ä¸ŠæŽ‰ä¸‹ä¾†çš„......10å„„å…ƒï¼",
    "266": "é£›å§ï¼è‚©æ¹å¼ç›´æ˜‡æ©Ÿï¼",
    "267": "å…©æ´¥è®Šå¤§äº†ï¼",
    "268": "å¤§å’Œé­‚ä¿å­˜æœƒï¼ï¼Ÿ",
    "269": "å…©æ´¥20é¢ç›¸",
    "270": "å¥ªå›žå½©åˆ¸å¤§ä½œæˆ°",
    "271": "ANGEL7å¥³è­¦éšŠV.S.ç‹‚é‡Žå¥½æ¼¢éšŠï¼",
    "272": "æª¸æª¬çš„è‚²å¬°å¥®é¬¥è¨˜",
    "273": "æ˜¯ç”·äººå°±è¦æœ‰é‡Žå¿ƒï¼",
    "274": "è¡°é‹é€£é€£çš„ä¸‰æœˆä¸‰æ—¥å¥³å…’ç¯€ï¼",
    "275": "å…©æ´¥å’Œå…©æ´¥ï¼ï¼Ÿ",
    "276": "é€™è£¡æ˜¯é›ªåœ‹æ´¾å‡ºæ‰€",
    "277": "é€™è£¡æ˜¯é‚£è£¡ï¼Ÿé›»æ¥µè‡­è€é ­ï¼",
    "278": "å¤§åŽŸæ‰€é•·è¿·ä¸Šé›»å‹•çŽ©å…·",
    "279": "æª¸æª¬ä¸å–œæ­¡åƒçš„æ±è¥¿",
    "280": "3å¹´Bç­ï¼Œå…©æ´¥è€å¸«ï¼",
    "281": "èª²é•·ï¼å…©æ´¥å‹˜å‰ï¼ï¼Ÿ",
    "282": "å…©æ´¥å’Œå°ç”ºä¿®æˆæ­£æžœï¼ï¼Ÿ",
    "283": "å‘½é‹çš„åˆ†æ­§é»ž",
    "284": "è‡¨åˆ¥çš„è´ˆç¦®",
    "285": "èº«é«”äº¤æ›è¨˜2--å…©æ´¥è®Šéº—å­ï¼Œéº—å­è®Šå…©æ´¥ï¼ï¼Ÿ",
    "286": "é£›å§ï¼é£›è¡Œèˆ¹éšŠ",
    "287": "é€™è£¡æ˜¯çƒé¾å»£æ’­é›»å°ï¼",
    "288": "ç†±æµ·ç« é­šä¹‹æ—…",
    "289": "åˆ°åº•åœ¨é‚£è£¡å•Šï¼é¾œæœ‰å…¬åœ’å‰è‡¨æ™‚æ´¾å‡ºæ‰€",
    "290": "å…©æ´¥ç†±æ„›å®£è¨€ï¼ï¼Ÿ",
    "291": "æ·ºè‰å°‘å¹´ä¹‹é˜¿é£›æ­£å‚³",
    "292": "å‘ç¥–å…ˆå•å¥½",
    "293": "å…‹æœé…·æš‘å¤§ä½œæˆ°",
    "294": "æª¸æª¬åŒ–èº«æˆå¥³å¿è€…",
    "295": "è€å¸«æ˜¯å¤©èŠ±äº‚å¢œå¹ç‰›å¤§çŽ‹",
    "296": "æˆ‘æ˜¯èª°ï¼ï¼Ÿ",
    "297": "é¯‰é­šå¤§é¨·å‹•",
    "298": "æ´¾å‡ºæ‰€çš„å¾€äº‹",
    "299": "æ±æ–¹å¿«è»Šç«Šç›œæ¡ˆ",
    "300": "è¡å§ï¼ä»£è·‘é‹å‹•æœƒ",
    "309": "åªæœ‰å…©äººç•™å®ˆçš„æ´¾å‡ºæ‰€",
    "310": "æ‹¼å•¦ï¼è»Šç«™å‰çš„æ”¤è²©å¤§æˆ°",
    "311": "çŽé‡‘çˆ­å¥ªæˆ°8",
    "312": "ä¼¸ç¸®è‡ªå¦‚çš„æ©¡è† å…©æ´¥",
    "313": "å…©æ´¥æµæ¼«ç•«è£œç¿’ç­",
    "314": "æˆ‘å°±æ˜¯ä¸æƒ³åšå˜›ï¼æ€Žæ¨£ï¼Ÿ/æ­£ç¾©ä½¿è€…ï¼Œå…©æ´¥ï¼Ÿ",
    "315": "å¥ˆç·’å­ï¼Œæ„å¤–çš„ä¸€å¤©",
    "316": "ä¸­å·å®¶çš„ç¹¼æ‰¿é¢¨æ³¢",
    "317": "å…©æ´¥V.S.ç™½é³¥éº—æ¬¡æ‰“å·¥å¤§æš´èµ°ï¼",
    "318": "æ­£ç›´è€…ï¼Œå…©æ´¥ï¼ï¼Ÿ",
    "319": "æžç¬‘åˆ¶è£è€…",
    "320": "æŠŠå¹³é ­æŽ¨å»£åˆ°å…¨ä¸–ç•Œå§ï¼",
    "321": "å°‹å›žè…³è¸è»Šå¤§ä½œæˆ°",
    "322": "é™°ç››é™½è¡°çš„æ´¾å‡ºæ‰€",
    "323": "æ­¡è¿Žä¾†åˆ°é¾œæœ‰å•†åº—è¡—ï¼",
    "326": "è¶…ç¥žç”°å£½å¸çœŸå·¥å¤«å°æ±º",
    "327": "è³žæ«»çœŸè¾›è‹¦",
    "328": "å…©æ´¥ç•¶é›»å½±å°Žæ¼”ï¼ï¼Ÿ",
    "329": "ç‹‚å¥”ï¼å¥§ä¹‹ç´°é“",
    "330": "æ‰€é•·ï¼Œè«‹å®‰å¿ƒé¤Šç—…......",
    "331": "éº—å­å’ŒçŽ‹å­çš„é¾œæœ‰å‡æœŸ",
    "332": "é€™æ‰æ˜¯ç”·äººçš„æŽ¡è‰èŽ“ä¹‹æ—…",
    "333": "æ­¡è¿Žé´•é³¥çš„ä¾†åˆ°ï¼",
    "334": "æ…˜çƒˆçš„æˆ°é¬¥å°‡æ£‹",
    "335": "éµè…•å…©æ´¥",
    "336": "å°‹æ‰¾æ—¥æš®ä¸‰åƒé‡Œ",
    "337": "çˆ¸çˆ¸æ˜¯éœ²ç‡Ÿè¡Œå®¶",
    "338": "ç„¡äººå³¶é«˜çˆ¾å¤«çƒ",
    "339": "å†åº¦ç™»å ´ï¼æœ¬ç”°ä¸€å®¶Final",
    "342": "æª¸æª¬é¬§ç½·å·¥",
    "343": "è®Šå½¢ï¼Beforeâ†â†’After",
    "344": "å°é ‘ç«¥å…©æ´¥",
    "345": "å»Ÿæœƒçš„å›žæ†¶",
    "346": "å¤§å®¶ä¾†è·³èˆž",
    "347": "ç™¼æ˜ŽçŽ‹å…©æ´¥",
    "348": "é–‹æ‡·å¤§ç¬‘......æŠ±æ­‰å•¦ï¼",
    "349": "èŠ±ä¹‹å­å…©æ´¥",
    "350": "åŠ æ²¹ï¼ç†Šè­¦å¯Ÿ",
    "351": "æ„›æˆ°å£«â€§å…©æ´¥å‹˜å‰",
    "352": "å¾æœé®ªé­šçš„è­¦å¯Ÿ",
    "353": "FINALã€Œçé‡å†è¦‹ï¼å…©æ´¥ã€å¤§ä½œæˆ°",
} 

# è¡¨æƒ…ç¬¦è™Ÿçš„ Unicode ç·¨ç¢¼èˆ‡ä¸­æ–‡çš„æ˜ å°„å­—å…¸
emoji_unicode_to_chinese = {
  
    'U+1F600': 'é–‹å¿ƒ',  # ðŸ˜€ Grinning face
    'U+1F601': 'ç¬‘',  # ðŸ˜ Grinning face with smiling eyes
    'U+1F602': 'ç¬‘',  # ðŸ˜‚ Face with tears of joy
    'U+1F603': 'å¤§ç¬‘',  # ðŸ˜ƒ Smiling face with open mouth
    'U+1F604': 'ç¬‘',  # ðŸ˜„ Smiling face with open mouth and smiling eyes
    'U+1F606': 'ç¬‘',  # ðŸ˜† Smiling face with open mouth and tightly-closed eyes
    'U+1F607': 'å¤©ä½¿',  # ðŸ˜‡ Smiling face with halo
    'U+1F608': 'æƒ¡é­”',  # ðŸ˜ˆ Smiling face with horns
    'U+1F609': 'çœ¨çœ¼',  # ðŸ˜‰ Winking face
    'U+1F60A': 'ç¬‘',  # ðŸ˜Š Smiling face with smiling eyes
    'U+1F60B': 'å¥½åƒ',  # ðŸ˜‹ Face savoring delicious food
    'U+1F60C': 'æ”¾é¬†',  # ðŸ˜Œ Relieved face
    'U+1F60E': 'é…·',  # ðŸ˜Ž Smiling face with sunglasses

    'U+1F617': 'è¦ª',  # ðŸ˜— Kissing face
    'U+1F618': 'è¦ª',  # ðŸ˜˜ Face throwing a kiss
    'U+1F62A': 'æ‰“å“ˆæ¬ ',  # ðŸ˜ª Yawning face
    'U+1F62D': 'å“­',  # ðŸ˜­ Loudly crying face
    'U+1F622': 'æ·š',  # ðŸ˜¢ Crying face
    'U+1F621': 'ç”Ÿæ°£',  # ðŸ˜¡ Pouting face
    'U+1F624': 'ç”Ÿæ°£',  # ðŸ˜¤ Face with steam from nose
    
    'U+1F633': 'è‡‰ç´…',  # ðŸ˜³ Flushed face
   
    'U+1F61E': 'å¤±æœ›',  # ðŸ˜ž Disappointed face

    
    
    'U+1F34E': 'è˜‹æžœ',
'U+1F34A': 'æ©˜å­',
'U+1F34C': 'é¦™è•‰',
'U+1F349': 'è¥¿ç“œ',
'U+1F347': 'è‘¡è„',
'U+1F353': 'è‰èŽ“',
'U+1F352': 'æ«»æ¡ƒ',
'U+1F34D': 'é³³æ¢¨',
'U+1F96D': 'èŠ’æžœ',
'U+1F95D': 'å¥‡ç•°æžœ',
'U+1F351': 'æ°´èœœæ¡ƒ',
'U+1F346': 'èŒ„å­',
'U+1F955': 'èƒ¡è˜¿è””',
'U+1F33D': 'çŽ‰ç±³',
'U+1F954': 'é¦¬éˆ´è–¯',
'U+1F360': 'åœ°ç“œ',
'U+1F952': 'é»ƒç“œ',
'U+1F96C': 'é’èœ',
'U+1F344': 'è˜‘è‡',
'U+1F95C': 'èŠ±ç”Ÿ',
'U+1F35E': 'éºµåŒ…',
'U+1F956': 'éºµåŒ…',
'U+1F96F': 'è²æžœ',
'U+1F9C0': 'èµ·å¸',
'U+1F355': 'æŠ«è–©',
'U+1F354': 'æ¼¢å ¡',
'U+1F32D': 'ç†±ç‹—',
'U+1F96A': 'ä¸‰æ˜Žæ²»',
'U+1F32E': 'å¢¨è¥¿å“¥æ²é¤…',
'U+1F359': 'é£¯ç³°',
'U+1F363': 'å£½å¸',
'U+1F35B': 'å’–å“©é£¯',
'U+1F35C': 'æ‹‰éºµ',
'U+1F95F': 'é¤ƒå­',
'U+1F362': 'ä¸²ç‡’',
'U+1F382': 'è›‹ç³•',
'U+1F369': 'ç”œç”œåœˆ',
'U+1F36A': 'é¤…ä¹¾',
'U+1F36B': 'å·§å…‹åŠ›',

'U+1F4F1': 'æ‰‹æ©Ÿ',
'U+1F4DE': 'é›»è©±',
'U+1F4BB': 'é›»è…¦',
'U+1F5A5': 'é›»è…¦',
'U+2328': 'éµç›¤',
'U+1F5B1': 'æ»‘é¼ ',
'U+1F5A8': 'å°è¡¨æ©Ÿ',
'U+1F579': 'éŠæˆ²',
'U+1F4F7': 'ç›¸æ©Ÿ',
'U+1F3A5': 'æ”å½±æ©Ÿ',
'U+1F4FA': 'é›»è¦–',
'U+1F4FB': 'æ”¶éŸ³æ©Ÿ',
'U+23F0': 'é¬§é˜',
'U+1F4A1': 'ç‡ˆ',
'U+1F526': 'æ‰‹é›»ç­’',
'U+1F50B': 'é›»æ± ',
'U+1F50C': 'æ’é ­',
'U+1F4E1': 'å¤©ç·š',
'U+1F399': 'éº¥å…‹é¢¨',
'U+1F4E0': 'å‚³çœŸ',
'U+1F511': 'é‘°åŒ™',
'U+1F6AA': 'é–€',
'U+1F6CF': 'åºŠ',
'U+1F6CB': 'æ²™ç™¼',
'U+1F6BD': 'é¦¬æ¡¶',
'U+1F6BF': 'æ·‹æµ´é–“',
'U+1F6C1': 'æµ´ç¼¸',
'U+1FA91': 'æ¤…å­',
'U+1F5BC': 'ç•«æ¡†',
'U+1F4DA': 'æ›¸ç±',
'U+1F4D6': 'æ›¸',
'U+2702': 'å‰ªåˆ€',
'U+1F58A': 'åŽŸå­ç­†',
'U+1F58D': 'è Ÿç­†',
'U+1F4CE': 'è¿´ç´‹é‡',
'U+1F4CF': 'å°º',

'U+1F697': 'æ±½è»Š',
'U+1F695': 'è¨ˆç¨‹è»Š',
'U+1F699': 'ä¼‘æ—…è»Š',
'U+1F68C': 'å…¬è»Š',
'U+1F68E': 'ç„¡è»Œé›»è»Š',
'U+1F3CE': 'è³½è»Š',
'U+1F693': 'è­¦è»Š',
'U+1F691': 'æ•‘è­·è»Š',
'U+1F692': 'æ¶ˆé˜²è»Š',
'U+1F690': 'å»‚åž‹è»Š',
'U+1F69A': 'è²¨è»Š',
'U+1F69B': 'æ‹–è»Šå¡è»Š',
'U+1F69C': 'æ‹–æ‹‰æ©Ÿ',
'U+1F6B2': 'è…³è¸è»Š',
'U+1F6F5': 'é€Ÿå…‹é”',
'U+1F3CD': 'æ‘©æ‰˜è»Š',
'U+1F682': 'ç«è»Š',
'U+1F686': 'ç«è»Š',
'U+1F687': 'åœ°éµ',
'U+1F69D': 'è»Š',
'U+1F680': 'ç«ç®­',
'U+2708': 'é£›æ©Ÿ',
'U+1F6E9': 'é£›æ©Ÿ',
'U+1F6EB': 'é£›æ©Ÿ',
'U+1F6EC': 'é£›æ©Ÿ',
'U+26F5': 'å¸†èˆ¹',
'U+1F6A4': 'å¿«è‰‡',
'U+1F6F3': 'å®¢è¼ª',
'U+26F4': 'æ¸¡è¼ª',
'U+1F6A2': 'è¼ªèˆ¹',
'U+2693': 'éŒ¨',
'U+1F5FA': 'åœ°åœ–',
'U+1F5FF': 'çŸ³åƒ',
'U+1F5FD': 'è‡ªç”±å¥³ç¥žåƒ',
'U+1F5FC': 'æ±äº¬éµå¡”',
'U+1F3F0': 'åŸŽå ¡',
'U+1F3EF': 'åŸŽå ¡',
'U+1F309': 'å¤œæ™š',
'U+1F306': 'é»ƒæ˜',

'U+26BD': 'è¶³çƒ',
'U+1F3C0': 'ç±ƒçƒ',
'U+1F3C8': 'æ©„æ¬–çƒ',
'U+26BE': 'æ£’çƒ',
'U+1F3BE': 'ç¶²çƒ',
'U+1F3D0': 'æŽ’çƒ',
'U+1F3C9': 'æ©„æ¬–çƒ',
'U+1F3B1': 'æ’žçƒ',
'U+1F3D3': 'æ¡Œçƒ',
'U+1F3F8': 'ç¾½æ¯›çƒ',
'U+1F94A': 'æ‹³æ“Šæ‰‹å¥—',
'U+1F94B': 'æŸ”é“',
'U+26F8': 'æºœå†°',
'U+1F3BF': 'æ»‘é›ª',
'U+1F3C4': 'è¡æµª',
'U+1F6B4': 'è…³è¸è»Š',
'U+1F3C7': 'è³½é¦¬',
'U+1F3CA': 'æ¸¸æ³³',
'U+1F3CB': 'èˆ‰é‡',
'U+1F3A4': 'éº¥å…‹é¢¨',
'U+1F3A7': 'è€³æ©Ÿ',
'U+1F3BC': 'äº”ç·šè­œ',
'U+1F3B9': 'é‹¼ç´',
'U+1F941': 'é¼“',
'U+1F3B7': 'è–©å…‹æ–¯é¢¨',
'U+1F3BA': 'å°è™Ÿ',
'U+1F3B8': 'å‰ä»–',
'U+1F3BB': 'å°æç´',
'U+1F579': 'æ–æ¡¿',
'U+1F3B2': 'éª°å­',
'U+1F004': 'éº»å°‡',
'U+265F': 'è¥¿æ´‹æ£‹',
'U+1F3C6': 'çŽç›ƒ',
'U+1F947': 'é‡‘ç‰Œ',
'U+1F948': 'éŠ€ç‰Œ',
'U+1F949': 'éŠ…ç‰Œ',
'U+1F3AD': 'é¢å…·',

 'U+1F468': 'è€å¸«',
'U+1F469': 'è€å¸«',
'U+1F46E': 'è­¦å¯Ÿ',
'U+1F468': 'é†«ç”Ÿ',
'U+1F9D1 200D 2695 FE0F': 'è­·å£«',
'U+1F477': 'å·¥äºº',
'U+1F473': 'æ¸…æ½”å·¥',
'U+1F475': 'å°ä¸‘', 
'U+1F9D1 200D 1F393': 'å­¸ç”Ÿ'

}
app = Flask(__name__)
 
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)
 
# JSONæ–‡ä»¶è·¯å¾‘ï¼ˆå‡è¨­èˆ‡app.pyåœ¨åŒä¸€ç›®éŒ„ï¼‰
pic_database_path = 'merged_output_with_url.json'

# å…¨å±€è®Šæ•¸å­˜å„²åŠ è¼‰çš„æ•¸æ“š
image_data = []

# é›†æ•¸æ¨™é¡Œï¼Œéœ€è¦åŠ å…¥å®Œæ•´çš„é›†æ•¸å°æ‡‰æ¨™é¡Œ
episode_titles = {}  # è‹¥æ²’æœ‰å®Œæ•´é›†æ•¸è³‡æ–™ï¼Œå¯ä¿æŒç‚ºç©ºå­—å…¸

# éŒ¯èª¤è¨Šæ¯
error_message = "æ‰¾ä¸åˆ°åœ–ç‰‡"
# åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚åŠ è¼‰JSONæ•¸æ“š
def load_image_data():
    global image_data
    try:
        with open(pic_database_path, 'r', encoding='utf-8') as f:
            image_data = json.load(f)
        print(f"æˆåŠŸåŠ è¼‰ {len(image_data)} æ¢åœ–ç‰‡æ•¸æ“š")
    except FileNotFoundError:
        print(f"éŒ¯èª¤: æ‰¾ä¸åˆ°æ–‡ä»¶ {pic_database_path}")
        image_data = []
    except json.JSONDecodeError:
        print(f"éŒ¯èª¤: ç„¡æ³•è§£æž JSON æ–‡ä»¶ {pic_database_path}")
        image_data = []

# æª¢æŸ¥åœ–ç‰‡åç¨±æ ¼å¼ (ä¾‹å¦‚ e00087)
def validate_image_number(message):
    pattern = r"^[Ee]\d{1,5}$"  # E æˆ– e é–‹é ­ï¼Œå¾Œé¢ 1~5 ä½æ•¸å­—
    return re.match(pattern, message) is not None

def normalize_image_number(message):
    pattern = r"^[Ee](\d{1,5})$"  # E æˆ– e é–‹é ­ï¼Œå¾Œé¢ 1~5 ä½æ•¸å­—
    match = re.match(pattern, message)
    if match:
        num = int(match.group(1))  # è½‰æ›ç‚ºæ•¸å­—ï¼ŒåŽ»æŽ‰å‰å°Žé›¶
        return f"e{num:05d}"  # è½‰æ›ç‚º e00008 æ ¼å¼
    return None


# å¾žå…§å­˜ä¸­æŸ¥æ‰¾åœ–ç‰‡æ•¸æ“š
def search_image_by_number(number):
    global image_data
    for entry in image_data:
        if number == entry['image_name']:
            return entry
    return None
 
# æœå°‹åœ–ç‰‡åç¨±èˆ‡å°æ‡‰ç·¨è™Ÿ
def search_by_keyword(keyword, strict=False):
    global image_data
    result = []
    for item in image_data:
        if strict:
            if keyword == item['text']:
                result.append(f"ã€{item['image_name']}ã€‘{item['text']}")
        else:
            if keyword in item['text']:
                result.append(f"ã€{item['image_name']}ã€‘{item['text']}")
    return result

# éš¨æ©ŸæŠ½å–ä¸€å€‹åœ–ç‰‡
def random_image():
    global image_data
    if not image_data:
        return None
    return random.choice(image_data)

# å‰µå»ºåœ–ç‰‡è©³ç´°ä¿¡æ¯çš„Flex Message
def create_flex_message(image_data):
    episode_number = image_data.get("episode", "æœªçŸ¥")
    episode_title = episode_titles.get(episode_number, "æœªçŸ¥é›†æ•¸")
    image_name = image_data.get("image_name", "")
    image_text = image_data.get("text", "")
    img_url = image_data.get("url", "")

    flex_content = {
        "type": "bubble",
        "hero": {
            "type": "image",
            "url": img_url,
            "size": "full",
            "aspectRatio": "16:9",
            "aspectMode": "cover"
        },
        "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {"type": "text", "text": f"ç·¨è™Ÿ: {image_name}", "weight": "bold", "size": "md"},
                {"type": "text", "text": f"é›†æ•¸: ç¬¬{episode_number}é›†", "size": "sm", "color": "#555555"},
                {"type": "text", "text": f"æ¨™é¡Œ: {episode_title}", "weight": "bold","size": "sm", "color": "#555555"},
                {"type": "text", "text": f"èªªæ˜Ž: {image_text}", "wrap": True, "size": "sm", "color": "#555555"}
            ]
        }
    }

    return FlexSendMessage(alt_text="åœ–ç‰‡è³‡è¨Š", contents=flex_content)

# å‰µå»ºQuick ReplyæŒ‰éˆ•
def create_quick_reply(buttons=None):
    # å¦‚æžœæœªæä¾›æŒ‰éˆ•ï¼Œå‰‡ä½¿ç”¨é»˜èªæŒ‰éˆ•
    if buttons is None:
        buttons = [
            ("é¸å–®", "menu"),
            ("æŠ½åœ–", "æŠ½")
        ]
    
    items = []
    for label, text in buttons:
        items.append(QuickReplyButton(action=MessageAction(label=label, text=text)))
    return QuickReply(items=items)

# å‰µå»ºåœ–ç‰‡é è¦½çš„Flex Message
def create_preview_flex_message(image_data):
    img_url = image_data.get("url", "")
    image_name = image_data.get("image_name", "")

    flex_content = {
        "type": "bubble",
        "hero": {
            "type": "image",
            "url": img_url,
            "size": "full",
            "aspectRatio": "16:9",
            "aspectMode": "cover"
        },
        "footer": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {
                    "type": "button",
                    "action": {"type": "message", "label": "é¡¯ç¤ºè³‡è¨Š", "text": f"info:{image_name}"},
                    "style": "primary"
                }       
            ]
        }
    }

    return FlexSendMessage(alt_text="åœ–ç‰‡é è¦½", contents=flex_content)

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    message = event.message.text.strip()

    # è™•ç†ã€Œmenuã€æŒ‡ä»¤
    if message.lower() == "menu":
        reply_message = "æ­¡è¿Žä½¿ç”¨å£½é™ç„¡å£½é™ç„¡äº”å»ä¹‹éºµç²‰å›ä¹‹çƒé¾æ´¾å‡ºæ‰€å‹•ç•«æ©Ÿå™¨äººï¼\n" \
                        "æŒ‡ä»¤åˆ—è¡¨ï¼š\n" \
                        "- è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚ e00087ï¼‰æŸ¥çœ‹åœ–ç‰‡\n" \
                        "- è¼¸å…¥é—œéµå­—æœå°‹åœ–ç‰‡åç¨±\n" \
                        "- è¼¸å…¥ã€ŒæŠ½ã€éš¨æ©ŸæŠ½å–ä¸€å¼µåœ–ç‰‡"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_message))
        return

    # è™•ç†ã€ŒæŠ½ã€æŒ‡ä»¤
    elif message == "æŠ½":
        random_img = random_image()
        if random_img:
            # ä½¿ç”¨åœ–ç‰‡ç·¨è™Ÿå‰µå»ºé©åˆçš„å¿«é€Ÿå›žè¦†æŒ‰éˆ•
            image_number = random_img['image_name']
            quick_reply = create_quick_reply([
                ("é›†æ•¸è³‡è¨Š", f"info:{image_number}"),
                ("å†æŠ½ä¸€æ¬¡", "æŠ½"),
                ("é¸å–®", "menu")
            ])
            
            line_bot_api.reply_message(
                event.reply_token,
                ImageSendMessage(
                    original_content_url=random_img['url'],
                    preview_image_url=random_img['url'],
                    quick_reply=quick_reply
                )
            )
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ç„¡æ³•æŠ½å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæ•¸æ“šå·²æ­£ç¢ºåŠ è¼‰ã€‚"))
        return
    
    # è™•ç†åœ–ç‰‡è³‡è¨Šè«‹æ±‚
    elif message.startswith("info:"):
        image_number = message.replace("info:", "")
        img_num = int(image_number[1:])  # æŠŠ e42574 å–æ•¸å­—éƒ¨åˆ†
        prev_number = f"e{img_num - 1:05d}"
        next_number = f"e{img_num + 1:05d}"
        
        img_data = search_image_by_number(image_number)
        if img_data:
            quick_reply = create_quick_reply([
                ("ä¸Šä¸€å¼µ", prev_number),
                ("ä¸‹ä¸€å¼µ", next_number),
                ("æŠ½", "æŠ½"),
                ("é¸å–®", "menu")
            ])
            flex_message = create_flex_message(img_data)
            line_bot_api.reply_message(
                event.reply_token,
                [flex_message, TextSendMessage(text="è«‹é¸æ“‡æ“ä½œï¼š", quick_reply=quick_reply)]
            )
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‰¾ä¸åˆ°åœ–ç‰‡è³‡è¨Šã€‚"))
        return

    # è™•ç†ä¸Šä¸€å¼µ/ä¸‹ä¸€å¼µæŒ‡ä»¤
    elif message.startswith("prev:") or message.startswith("next:"):
        if message.startswith("prev:"):
            current_image = message.replace("prev:", "")
            img_num = int(current_image[1:])
            target_image = f"e{img_num - 1:05d}"
        else:  # next:
            current_image = message.replace("next:", "")
            img_num = int(current_image[1:])
            target_image = f"e{img_num + 1:05d}"
            
        img_data = search_image_by_number(target_image)
        if img_data:
            # è™•ç†é¡¯ç¤ºæ–°åœ–ç‰‡çš„é‚è¼¯
            quick_reply = create_quick_reply([
                ("ä¸Šä¸€å¼µ", f"prev:{target_image}"),
                ("ä¸‹ä¸€å¼µ", f"next:{target_image}"),
                ("é›†æ•¸è³‡è¨Š", f"info:{target_image}"),
                ("æŠ½", "æŠ½")
            ])
            line_bot_api.reply_message(
                event.reply_token,
                ImageSendMessage(
                    original_content_url=img_data['url'],
                    preview_image_url=img_data['url'],
                    quick_reply=quick_reply
                )
            )
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‰¾ä¸åˆ°åœ–ç‰‡ã€‚"))
        return

    # è™•ç†åœ–ç‰‡ç·¨è™Ÿè«‹æ±‚
    elif validate_image_number(message):
        normalized_message = normalize_image_number(message)  # è½‰æ› e8 -> e00008
        img_data = search_image_by_number(normalized_message)
        if img_data:
            quick_reply = create_quick_reply([
                ("ä¸Šä¸€å¼µ", f"{normalize_image_number(f'e{int(normalized_message[1:]) - 1}')}" if int(normalized_message[1:]) > 1 else "e00001"),
                ("ä¸‹ä¸€å¼µ", f"{normalize_image_number(f'e{int(normalized_message[1:]) + 1}')}" if int(normalized_message[1:]) < 18859 else "e18859"),
                ("é›†æ•¸è³‡è¨Š", f"info:{normalized_message}"),
                ("æŠ½", "æŠ½")
            ])
            line_bot_api.reply_message(
                event.reply_token,
                ImageSendMessage(
                    original_content_url=img_data['url'],
                    preview_image_url=img_data['url'],
                    quick_reply=quick_reply
                )
            )
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‰¾ä¸åˆ°åœ–ç‰‡ã€‚"))
        return

    # è™•ç†åš´æ ¼æœç´¢è«‹æ±‚
    elif message.startswith("strict:"):
        keyword = message.replace("strict:", "").strip()
        search_result = search_by_keyword(keyword, strict=True)
        
        if search_result:  
            reply_message = "\n".join(search_result)
        else:
            reply_message = "æ‰¾ä¸åˆ°ç¬¦åˆçš„åœ–ç‰‡åç¨±ã€‚"
            
        quick_reply = create_quick_reply([
            ("é¸å–®", "menu"),
            ("æŠ½åœ–", "æŠ½")
        ])
        
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(
                text=reply_message,
                quick_reply=quick_reply
            )
        )
        return
        
# Handle single emoji input
    elif len(message) == 1:
        # Convert emoji to Unicode representation
        unicode_str = f'U+{ord(message[0]):X}'
        
        # Check if this emoji is in our dictionary
        if unicode_str in emoji_unicode_to_chinese:
            # Get the corresponding Chinese text
            chinese_meaning = emoji_unicode_to_chinese[unicode_str]
            
            # Instead of explaining the emoji, directly process the Chinese text
            # as if the user had sent that text
            search_result = search_by_keyword(chinese_meaning, strict=False)
            
            if search_result: 
                reply_message = "\n".join(search_result)
            else:
                reply_message = "æ‰¾ä¸åˆ°ç¬¦åˆçš„åœ–ç‰‡åç¨±ã€‚"
        else:
            reply_message = "æˆ‘ä¸èªè­˜é€™å€‹è¡¨æƒ…ç¬¦è™Ÿï¼"
        
        quick_reply = create_quick_reply([
            ("é¸å–®", "menu"),
            ("æŠ½åœ–", "æŠ½")
        ])
        
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(
                text=reply_message,
                quick_reply=quick_reply
            )
        )
        return
    # é—œéµå­—æœå°‹ï¼ˆé»˜èªè¡Œç‚ºï¼‰
    else:
        search_result = search_by_keyword(message)
        if search_result:  
            reply_message = "\n".join(search_result)
        else:
            reply_message = "æ‰¾ä¸åˆ°ç¬¦åˆçš„åœ–ç‰‡åç¨±ã€‚"

        quick_reply = create_quick_reply([
            ("é¸å–®", "menu"),
            ("æŠ½åœ–", "æŠ½")
        ])
        
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(
                text=reply_message,
                quick_reply=quick_reply
            )
        )

# å•Ÿå‹•æ‡‰ç”¨æ™‚åŠ è¼‰åœ–ç‰‡æ•¸æ“š
load_image_data()

if __name__ == "__main__":
    app.run(debug=True)
